# Detection Engineering & Dashboards

This document details the process of moving from data collection to active threat detection. Using the ingested logs from the Linux and Windows endpoints, this phase focuses on writing **Splunk Processing Language (SPL)** queries to identify suspicious activity, creating dashboards for visualization, and setting up alerts.

---
## 1. Use Case: Detecting Brute-Force Activity on Linux

The first detection use case focuses on identifying potential SSH brute-force attacks against the Linux endpoint. This is a common attack vector where an adversary attempts to guess user credentials repeatedly.

### 1.1 - Data Generation
To ensure the detection query was effective, realistic log data was generated by simulating several failed SSH login attempts on the Linux host.

<img width="654" height="441" alt="image" src="https://github.com/user-attachments/assets/b951e6bd-5353-4a06-b727-eb6363522aeb" />

### 1.2 - Detection Query Development
The following SPL query was developed to find and aggregate these failed login events. A key step in this process was using the `rex` command to manually extract the `user` and `src_ip` fields, as they were not automatically identified by Splunk.

```spl
index="main" sourcetype="linux_secure" "Failed password for"
| rex "Failed password for(?: invalid user)? (?<user>\S+) from (?<src_ip>\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3})"
| stats count by user src_ip
| rename src_ip as "Source IP", user as "Username"
| sort -count
```
* **`rex`**: Extracts the username and source IP from the raw log text.
* **`stats`**: Counts the number of failures and groups them by the newly extracted fields.
* **`rename` / `sort`**: Cleans up the column names and sorts the results to show the most frequent attempts at the top.

The successful query results are shown below on the "Statistics" tab.

<img width="957" height="502" alt="image" src="https://github.com/user-attachments/assets/efa9a308-a2e8-4bea-bd33-8643eccd35a2" />

### 1.3 - Operationalizing the Detection
To make this detection useful for daily monitoring, the query was saved as a **Report** named "Linux - Failed SSH Login Attempts".

<img width="960" height="325" alt="image" src="https://github.com/user-attachments/assets/a10590f3-0a2d-4c95-bb0d-452ebc938ca6" />

Next, the report was added as a new panel to a **Dashboard** titled "SOC Overview". This provides at-a-glance visibility of potential brute-force activity for a SOC analyst.

<img width="943" height="507" alt="image" src="https://github.com/user-attachments/assets/83c9e800-099c-454f-80db-59945eb0e892" />

---
## 2. Use Case: Detecting Suspicious PowerShell Activity

The second detection focuses on identifying suspicious PowerShell execution on the Windows 11 endpoint, a common technique used by attackers for "living-off-the-land" attacks.

### 2.1 - Initial Detection Attempt & Troubleshooting
The process began by generating a test event using an encoded PowerShell command, a common obfuscation method. However, the initial Splunk queries failed to find the event.

<img width="1253" height="840" alt="image" src="https://github.com/user-attachments/assets/b5b91aa9-a37f-4974-b365-ec81035aa780" />
<img width="1916" height="551" alt="image" src="https://github.com/user-attachments/assets/550c1959-20f0-4e55-9607-a4af6386df81" />

An investigation determined that I was using EventID instead of EventCode, making the searches fail.

### 2.2 - Detection Query Development (Post-Fix)
A new test event was generated using `Invoke-Expression` (`iex`), another suspicious indicator.

<img width="1023" height="839" alt="image" src="https://github.com/user-attachments/assets/f37366a9-3a22-4f58-bd89-763b2c2442d9" />

The following query was then used to successfully find the event.

```spl
sourcetype="Sysmon" EventCode=1 Image="*\\powershell.exe" CommandLine
```
The successful search results, showing the raw event text and the command line arguments, are shown below.

<img width="1229" height="414" alt="image" src="https://github.com/user-attachments/assets/5b2c9b0b-9d7b-4719-a44c-ec49746c7f43" />
<img width="1911" height="831" alt="image" src="https://github.com/user-attachments/assets/640d34f3-17a2-4959-9186-af4774c8c4c4" />

### 2.3 - Operationalizing the Detection
Finally, the successful query was saved as a report and added to the "SOC Overview" dashboard.

---
## 3. Final SOC Dashboard

The result is a single-pane-of-glass dashboard providing visibility into key potential threats on both Linux and Windows endpoints, simulating a core function of a real-world Security Operations Center.

<img width="1912" height="849" alt="image" src="https://github.com/user-attachments/assets/75c63a7e-23c1-450b-b160-235f8d867413" />

---
## 4. Operationalizing Detections with Automated Alerts

While dashboards are great for visualization, a SOC needs automated alerts to be notified of threats in real-time. This section covers converting the "Failed SSH Logins" detection into a scheduled alert.

### 3.1 - Alert Configuration
The saved report was configured to run on a schedule and trigger an action if results were found. Key best practices were implemented:
* **Schedule:** The alert was set to run every 5 minutes using a cron schedule (`*/5 * * * *`).
* **Time Range:** The time range was set to match the schedule (**"Last 5 minutes"**) to ensure only new events are processed, preventing duplicate alerts.
* **Trigger Action:** A "Log Event" action was configured with custom text using tokens (`$result.user$`, `$result.src_ip$`) to create an enriched, informative alert event.

<img width="1917" height="853" alt="image" src="https://github.com/user-attachments/assets/c629b0f0-40fd-4bfd-ac3e-e3fdc8cfac8b" />
<img width="800" height="771" alt="image" src="https://github.com/user-attachments/assets/62001a80-eed8-427a-95dc-67171a226f71" />

### 4.2 - Verification
To test the alert, a failed SSH login was simulated on the Linux host.

<img width="653" height="438" alt="image" src="https://github.com/user-attachments/assets/476bff4b-ba62-4887-a379-1d4ae5386676" />

A search against Splunk's internal logs (`index=_internal sourcetype=splunkd_alert_actions`) confirmed that the alert fired successfully, logging the custom event with the attacker's details.

<img width="1916" height="851" alt="image" src="https://github.com/user-attachments/assets/53a9f4ba-43c1-4979-8d2e-2ec025c87f08" />

